name: Sync with upstream

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Запуск раз в неделю
  workflow_dispatch:  # Добавляем возможность ручного запуска

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream repository
        run: |
          git remote add upstream https://github.com/ActivityWatch/activitywatch.git
          git fetch upstream

      - name: Sync branches
        run: |
          # Проверяем текущую ветку
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          
          # Пробуем выполнить merge
          if git merge upstream/master --allow-unrelated-histories; then
            echo "Merge successful"
          else
            echo "Merge failed, attempting alternative approach..."
            # Отменяем неудачный merge
            git merge --abort
            
            # Создаем временную ветку
            git checkout -b temp_merge_branch
            
            # Пробуем принудительно применить изменения
            git reset --soft upstream/master
            git add .
            git commit -m "Sync with upstream/master (forced update)"
            
            # Возвращаемся на основную ветку
            git checkout $CURRENT_BRANCH
            git merge temp_merge_branch --allow-unrelated-histories
            
            # Удаляем временную ветку
            git branch -D temp_merge_branch
          fi

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin main || {
            echo "Push failed, trying force push..."
            git push -f origin main
          }